# Claude Code 作業方針

## 目的

このドキュメントは、Claude Code がこのプロジェクトで作業する際の方針とプロジェクト固有のルールを定義します。

## 判断記録のルール

判断は必ずレビュー可能な形で記録すること:

1. 判断内容の要約
2. 検討した代替案
3. 採用しなかった案とその理由
4. 前提条件・仮定・不確実性
5. 他エージェントによるレビュー可否

前提・仮定・不確実性を明示し、仮定を事実のように扱わない。

## プロジェクト概要

- 目的: 日付つきの作業ディレクトリを素早く作成して移動するためのシェル関数ユーティリティ
- 主な機能:
  - `~/work/YYYYMMDD_name` を自動作成
  - 作成後そのディレクトリへ `cd`
  - 自動更新チェック・更新機能
  - インストール/アンインストール

## 重要ルール

- **会話言語**: 日本語
- **コミット規約**: Conventional Commits に従い、`<description>` は日本語で記載
- **コメント言語**: 日本語
- **エラーメッセージ言語**: 英語
- **日本語と英数字の間**: 半角スペースを挿入

## 環境のルール

- **ブランチ命名**: Conventional Branch に従う（`<type>/<description>`、`<type>` は短縮形）
- **GitHub リポジトリ調査**: テンポラリディレクトリに git clone してコード検索
- **Renovate PR**: 追加コミットや更新を行わない

## コード改修時のルール

- 日本語と英数字の間には、半角スペースを挿入する
- エラーメッセージは英語で記載する（絵文字は使用しない）
- 関数には docstring（コメント）を日本語で記載・更新する
- POSIX Shell 互換の記法を優先する
- 関数名は `mkwork__` プレフィックスを使用する
- ShellCheck の警告に従う

## 相談ルール

### Codex CLI (ask-codex)

- 実装コードに対するソースコードレビュー
- 関数設計、モジュール内部の実装方針などの局所的な技術判断
- シェルスクリプトのセキュリティ、パフォーマンスの判断
- 実装の正当性確認、機械的ミスの検出

### Gemini CLI (ask-gemini)

- 最新の GitHub API 仕様、curl/jq のバージョン差
- 外部一次情報の確認、最新仕様の調査

### 他エージェント指摘への対応

他エージェントが指摘・異議を提示した場合、以下のいずれかを行う。黙殺・無言での不採用は禁止:

- 指摘を受け入れ、判断を修正する
- 指摘を退け、その理由を明示する

以下は必ず実施:

- 他エージェントの提案を鵜呑みにせず、その根拠や理由を理解する
- 自身の分析結果と他エージェントの意見が異なる場合は、双方の視点を比較検討する
- 最終的な判断は、両者の意見を総合的に評価した上で、自身で下す

## 開発コマンド

```bash
# シンタックスチェック
sh -n mkwork.sh

# ShellCheck による静的解析
shellcheck mkwork.sh

# スモークテスト（基本動作確認）
# 一時ディレクトリでテスト実行
tmp_dir="$(mktemp -d)"
export HOME="$tmp_dir/home"
mkdir -p "$HOME"
. ./mkwork.sh
mkwork --version
mkwork --doctor
mkwork testdir
test -d "$HOME/work/$(date +%Y%m%d)_testdir"
```

## アーキテクチャと主要ファイル

### アーキテクチャサマリー

単一の `mkwork.sh` ファイルで構成されるシェル関数ユーティリティ:

- **シェル関数**: `mkwork` 関数が親シェルで動作し、`mkdir + cd` を一体化
- **内部関数**: `mkwork__` プレフィックスの内部関数で機能を分離
- **設定管理**: `~/.config/mkwork/config` または `/etc/mkwork/config`
- **状態管理**: `~/.local/state/mkwork/state.json` で更新チェック状態を管理

### 主要ファイル

- `mkwork.sh`: 本体スクリプト
- `README.md`: 英語ドキュメント
- `README-ja.md`: 日本語ドキュメント
- `.github/workflows/shellcheck.yml`: ShellCheck による静的解析
- `.github/workflows/smoke-test.yml`: スモークテスト
- `.github/workflows/release.yml`: リリースアセット生成

## 実装パターン

### 推奨パターン

- POSIX Shell 互換の記法を使用する
- 関数は単一責任の原則に従う
- エラー時は適切に `return 1` する
- 外部コマンドの失敗を適切にハンドリングする
- グローバル変数の汚染を避ける（`mkwork__` プレフィックス）

### 非推奨パターン

- Bash 固有の機能に依存しない（POSIX 互換性維持）
- 外部コマンドへの過度な依存（本体機能は外部依存なし）
- ハードコードされたパス（設定可能にする）

## テスト

### テスト方針

- **静的解析**: ShellCheck でコードの品質を保つ
- **スモークテスト**: 基本的な動作を確認する
- **手動テスト**: インストール/アンインストール/更新の動作を確認する

### 追加テスト条件

新機能を追加する場合:

1. ShellCheck の警告が出ないこと
2. スモークテストに新機能のケースを追加すること
3. インストール/アンインストール/更新が正常に動作すること

## ドキュメント更新ルール

### 更新対象

- `README.md` (英語)
- `README-ja.md` (日本語)

### 更新タイミング

- 新機能追加時
- コマンドライン引数の変更時
- 設定項目の追加・変更時
- 依存関係の変更時

## 作業チェックリスト

### 新規改修時

1. プロジェクトを理解する
2. 作業ブランチが適切であることを確認する（PR クローズ済みブランチでないこと）
3. 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. PR がクローズされた不要ブランチが削除済みであることを確認する
5. 依存パッケージのインストールは不要（シェルスクリプトプロジェクト）

### コミット・プッシュ前

1. コミットメッセージが Conventional Commits に従っていることを確認する
2. センシティブな情報が含まれていないことを確認する
3. ShellCheck エラーがないことを確認する (`shellcheck mkwork.sh`)
4. シンタックスチェックが通ることを確認する (`sh -n mkwork.sh`)
5. スモークテストが通ることを確認する

### PR 作成前

1. PR 作成の依頼があることを確認する
2. センシティブな情報が含まれていないことを確認する
3. コンフリクトの恐れがないことを確認する

### PR 作成後

1. コンフリクトがないことを確認する
2. PR 本文が最新状態のみを網羅していることを確認する（履歴は含めない）
3. `gh pr checks <PR ID> --watch` で CI を確認する
4. Copilot レビューに対応し、コメントに返信する
5. `/code-review:code-review` でコードレビューを実施し、スコア 50 以上の指摘に対応する
6. PR 本文の崩れがないことを確認する

## リポジトリ固有

- このプロジェクトは単一の `mkwork.sh` ファイルで構成される
- リリース時に GitHub Actions が自動的に `MKWORK_VERSION` を注入する
- 更新チェック・更新機能は `curl`, `jq`, `sha256sum`/`shasum` に依存するが、本体機能（ディレクトリ作成と移動）は外部コマンドに依存しない
- シェル関数として動作するため、親シェルの `cwd` を変更できる
- インストール先は非 root の場合 `~/.local/share/mkwork/mkwork.sh`、root の場合 `/usr/local/share/mkwork/mkwork.sh`
- 設定ファイルは `~/.config/mkwork/config` または `/etc/mkwork/config`
- 状態ファイルは `~/.local/state/mkwork/state.json` または `/var/lib/mkwork/state.json`
